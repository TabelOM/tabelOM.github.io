<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Tabel Kalkulasi - Dynamic Running Text</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  html, body {
    margin: 0; padding: 0; height: 100%; overflow: hidden;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  .container { position: relative; width: 100%; height: 100vh; }
  iframe { width: 100%; height: 100%; border: none; }

  /* RUNNING TEXT */
  #running-text {
    position: absolute; top: 0; width: 100%; height: 25px;
    z-index: 10000; pointer-events: none;
  }
  .running-inner-bar {
    height: 100%; margin: 0 250px;
    background: rgba(18, 52, 88, 0.85); overflow: hidden;
    mask-image: linear-gradient(to right, transparent 0%, black 10%, black 90%, transparent 100%);
  }
  .running-inner { margin: 0 10px; overflow: hidden; }
  #running-text span {
    display: inline-block; white-space: nowrap; padding-left: 100%;
    font-size: 1rem; font-weight: 600; color: #fff;
    animation: marquee 20s linear infinite;
  }
  @keyframes marquee {
    from { transform: translateX(0); }
    to   { transform: translateX(-100%); }
  }

  /* JAM */
  #digital-clock {
    position: absolute; top: 0; left: 50%; transform: translateX(-50%);
    z-index: 10001; background: #123458; color: white;
    padding: 8px 26px; font-weight: bold; font-size: 1.1rem;
    border-radius: 0 0 12px 12px; cursor: pointer;
  }

  /* MODAL */
  .rt-modal {
    position: fixed; inset: 0; background: rgba(0,0,0,0.6);
    display: none; z-index: 20000;
  }
  .rt-box {
    background: #fff; width: 90%; max-width: 520px;
    margin: 80px auto; padding: 15px; border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }
  #rt-input { width: 100%; height: 80px; resize: none; padding: 8px; box-sizing: border-box; }
  .char-count { text-align: right; font-size: 0.85rem; color: #666; }
  .rt-buttons { display: flex; gap: 10px; margin-top: 10px; }
  button { padding: 8px 15px; cursor: pointer; border: none; border-radius: 5px; }
  .btn-save { background: #123458; color: white; }
  .btn-close { background: #ddd; }
  
  #rt-list { list-style: none; padding: 0; margin-top: 15px; max-height: 250px; overflow-y: auto; }
  #rt-list li {
    display: flex; align-items: center; gap: 8px;
    padding: 8px 5px; border-bottom: 1px solid #eee;
  }
  .rt-text { flex: 1; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .delete-btn { color: #c00; cursor: pointer; padding: 5px; font-size: 1.1rem; }
  .delete-btn:hover { background: #ffecec; border-radius: 4px; }
</style>
</head>
<body>

<div class="container">
  <div id="running-text">
    <div class="running-inner-bar">
      <div class="running-inner">
        <span id="running-content">Menghubungkan ke Sheets...</span>
      </div>
    </div>
  </div>

  <div id="digital-clock" title="Klik untuk kelola teks">00:00:00</div>

  <iframe src="https://www.appsheet.com/start/1474754a-c8a9-4660-aeef-d197abcbdf76?platform=mobile#appName=TabelKalkulasiV1-761441667&view=Dashboard"></iframe>
</div>

<div id="rt-modal" class="rt-modal">
  <div class="rt-box">
    <h3>üìù Kelola Running Text</h3>
    <textarea id="rt-input" maxlength="120" placeholder="Ketik pesan baru di sini..."></textarea>
    <div class="char-count"><span id="charCount">0</span> / 120</div>

    <div class="rt-buttons">
      <button class="btn-save" id="btnSave" onclick="saveText()">üíæ Simpan</button>
      <button class="btn-close" onclick="closeModal()">‚ùå Tutup</button>
    </div>

    <ul id="rt-list"></ul>
  </div>
</div>

<script>
/* KONFIGURASI */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzgD28b-fYtqB0a6ke-s9YrUg4WbCzL41deQqBJAzhszIhxaj2OFQM6I5-Hj8Uf9gxb/exec";
let messages = [];
let editID = null;

/* JAM */
function updateClock() {
  document.getElementById("digital-clock").innerText = new Date().toLocaleTimeString("id-ID");
}
setInterval(updateClock, 1000);
updateClock();

/* AMBIL DATA DARI SHEETS (READ) */
async function fetchSheetsData() {
  try {
    const response = await fetch(SCRIPT_URL);
    const result = await response.json();
    // Jika API mengembalikan object {data: [...]}, gunakan result.data
    messages = Array.isArray(result) ? result : result.data;
    renderList();
    displayRandomText();
  } catch (error) {
    console.error("Fetch Error:", error);
    document.getElementById("running-content").textContent = "Gagal memuat data.";
  }
}

/* TAMPILKAN TEKS DI MARQUEE */
function displayRandomText() {
  if (messages.length === 0) return;
  const span = document.getElementById("running-content");
  const randomMsg = messages[Math.floor(Math.random() * messages.length)];
  
  span.style.animation = "none";
  span.offsetHeight; // trigger reflow
  span.textContent = randomMsg.Text; // Ambil kolom 'Text'
  span.style.animation = "marquee 20s linear infinite";
}

/* RENDER DAFTAR DI MODAL */
function renderList() {
  const ul = document.getElementById("rt-list");
  ul.innerHTML = "";
  messages.forEach(item => {
    const li = document.createElement("li");
    li.innerHTML = `
      <div class="rt-text" onclick="prepareEdit('${item.ID}', '${item.Text}')" title="Klik untuk edit">
        ${item.Text}
      </div>
      <div class="delete-btn" onclick="deleteData('${item.ID}')">üóëÔ∏è</div>
    `;
    ul.appendChild(li);
  });
}

/* MODAL LOGIC */
document.getElementById("digital-clock").onclick = () => {
  document.getElementById("rt-modal").style.display = "block";
  fetchSheetsData();
};

function closeModal() {
  document.getElementById("rt-modal").style.display = "none";
  resetForm();
}

function prepareEdit(id, text) {
  editID = id;
  document.getElementById("rt-input").value = text;
  updateCounter();
}

function resetForm() {
  editID = null;
  document.getElementById("rt-input").value = "";
  updateCounter();
}

/* SIMPAN / UPDATE (CREATE & UPDATE) */
async function saveText() {
  const text = document.getElementById("rt-input").value.trim();
  if (!text) return;

  const btn = document.getElementById("btnSave");
  btn.disabled = true;
  btn.textContent = "‚è≥...";

  const payload = {
    action: editID ? "update" : "insert",
    ID: editID || new Date().getTime().toString(),
    Text: text,
    KeyInTime: new Date().toLocaleString("id-ID")
  };

  try {
    await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    });
    resetForm();
    await fetchSheetsData();
  } catch (e) {
    alert("Gagal menyimpan ke Sheets");
  } finally {
    btn.disabled = false;
    btn.textContent = "üíæ Simpan";
  }
}

/* HAPUS (DELETE) */
async function deleteData(id) {
  if (!confirm("Hapus teks ini secara permanen?")) return;
  
  try {
    await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify({ action: "delete", ID: id })
    });
    await fetchSheetsData();
  } catch (e) {
    alert("Gagal menghapus");
  }
}

/* UI HELPERS */
const input = document.getElementById("rt-input");
const counter = document.getElementById("charCount");
function updateCounter() { counter.innerText = input.value.length; }
input.addEventListener("input", updateCounter);

// Inisialisasi awal
fetchSheetsData();
setInterval(displayRandomText, 15000); // Ganti teks setiap 15 detik
</script>

</body>
</html>
